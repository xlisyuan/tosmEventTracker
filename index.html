<!doctype html>
<html lang="en">
  <head>
    <!-- æˆ‘çŸ¥é“æ”¾é€™é‚Šæ˜¯å…¬é–‹çš„XD-->
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6FZ92PW6TR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6FZ92PW6TR');
    </script>
    <!-- ğŸ”½ Firebase Firestore æ•´åˆæ¨¡çµ„ï¼Œè«‹ç›´æ¥è²¼åœ¨ </body> å‰ ğŸ”½ -->
<script type="module">
  // 1ï¸âƒ£ è¼‰å…¥ Firebase SDK (v11 æ¨¡çµ„ç‰ˆ)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, setDoc, deleteDoc,
    onSnapshot, query, where, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // 2ï¸âƒ£ ä½ çš„ Firebase è¨­å®šï¼ˆä¿æŒé€™çµ„ä¸è®Šï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyDMuk8fWfq4jTj76SBH8iOMZUNedhTJ3m0",
    authDomain: "webapp-ceb18.firebaseapp.com",
    projectId: "webapp-ceb18",
    storageBucket: "webapp-ceb18.firebasestorage.app",
    messagingSenderId: "1094462364537",
    appId: "1:1094462364537:web:4a6ea7926ff19b9be2eda8",
    measurementId: "G-ZGQNRBVDK2"
  };

  // åˆå§‹åŒ–
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const eventsCol = collection(db, "events");

  // 3ï¸âƒ£ å…±ç”¨ç‹€æ…‹
  window.cloud = { unsubscribe: null };

  // 4ï¸âƒ£ æŠŠ Firestore è³‡æ–™è½‰æ›æˆå¯é¡¯ç¤ºçš„æ ¼å¼
  function mapDocToRow(d) {
    const x = d.data();
    return {
      id: d.id,
      BOSS: x.BOSS || "",
      channel: x.channel || "",
      note: x.note || "",
      time: x.time || "",
      updatedAt: x.updatedAt?.toMillis?.() || 0,
    };
  }

  // 5ï¸âƒ£ å°‡è³‡æ–™ç¹ªè£½åˆ°é é¢ï¼ˆæ²’æœ‰ renderTable æ™‚çš„ä¿åº•æ–¹å¼ï¼‰
  function renderFallback(rows) {
    let tbody = document.querySelector("#recordsBody");
    if (!tbody) {
      const table = document.createElement("table");
      table.style.margin = "20px auto";
      table.style.borderCollapse = "collapse";
      table.style.width = "90%";
      table.innerHTML = `
        <thead>
          <tr>
            <th>BOSS</th><th>Channel</th><th>Note</th><th>Time</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
      `;
      document.body.appendChild(table);
      tbody = table.querySelector("#recordsBody");
    }

    tbody.innerHTML = rows.map(r => `
      <tr data-id="${r.id}">
        <td>${r.BOSS}</td>
        <td>${r.channel}</td>
        <td>${r.note}</td>
        <td>${r.time}</td>
        <td><button class="btn-del" data-id="${r.id}">åˆªé™¤</button></td>
      </tr>
    `).join("");

    tbody.querySelectorAll(".btn-del").forEach(b => {
      b.onclick = () => cloudRemove(b.dataset.id);
    });
  }

  // 6ï¸âƒ£ å•Ÿå‹• Firestore å³æ™‚ç›£è½
  function startRealtime() {
    if (window.cloud.unsubscribe) window.cloud.unsubscribe();
    const q = query(eventsCol, orderBy("updatedAt", "desc"));
    window.cloud.unsubscribe = onSnapshot(q, (snap) => {
      const rows = snap.docs.map(mapDocToRow);
      renderFallback(rows);
    });
  }

  // 7ï¸âƒ£ Firestore æ“ä½œå‡½å¼
  async function cloudAdd({ BOSS, channel, note, time }) {
    await addDoc(eventsCol, {
      BOSS, channel, note, time,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
  }

  async function cloudRemove(id) {
    await deleteDoc(doc(db, "events", id));
  }

  async function cloudUpdate(id, patch) {
    await setDoc(doc(db, "events", id), { ...patch, updatedAt: serverTimestamp() }, { merge: true });
  }

  // 8ï¸âƒ£ å°‡æ“ä½œç¶å®šåˆ°å…¨åŸŸï¼ˆæ–¹ä¾¿ä½ çš„å…¶ä»– JS å‘¼å«ï¼‰
  window.cloudAdd = cloudAdd;
  window.cloudRemove = cloudRemove;
  window.cloudUpdate = cloudUpdate;
  window.cloudStart = startRealtime;

  // 9ï¸âƒ£ åˆå§‹åŒ–ç›£è½
  startRealtime();

  console.log("%cFirebase Firestore å·²å•Ÿç”¨ âœ“", "color:#4caf50;font-weight:bold;");
</script>
<!-- ğŸ”¼ Firebase Firestore æ•´åˆçµæŸ ğŸ”¼ -->

    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TOSMé‡å¤–æ´»å‹•è¿½è¹¤</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
